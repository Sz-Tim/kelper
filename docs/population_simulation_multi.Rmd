---
title: "KELPER"
subtitle: "Population simulation: Multi-population"
author: "Tim Szewczyk"
output:
  html_document:
    theme: spacelab
    df_print: paged
    anchor_sections: TRUE
    toc: yes
    toc_depth: 2
    toc_float: true
  pdf_document:
    toc: yes
  html_notebook:
    theme: spacelab
    toc: yes
editor_options: 
  chunk_output_type: console
---

# Overview

This script simulates an individual population using data from the literature.


```{r setup, echo=F, include=F}
# set directory for knitr as main project directory
knitr::opts_knit$set(root.dir=rprojroot::find_rstudio_root_file())
```

```{r workspace, echo=F, include=F, message=F, warning=F}
pkgs <- c("raster", "lubridate", "tidyverse", "sf", "brms")
suppressMessages(invisible(lapply(pkgs, library, character.only=T)))
walk(dir("code", "^00.*R", full.names=T), source)
theme_set(theme_bw()); options(mc.cores=12)

gis.dir <- "..\\..\\00_gis\\"
UK_bbox <- st_bbox(c(xmin=-11, xmax=2, ymin=49, ymax=61), crs=st_crs(4326))
coast <- read_sf(paste0(gis.dir, "coastline\\ne_10m_land.shp")) %>%
  add_row(read_sf(paste0(gis.dir, "coastline\\ne_10m_minor_islands.shp"))) %>%
  st_crop(UK_bbox)
data.dir <- "..\\data\\digitized\\"
supp.f <- "..\\data\\collab\\collab_all.xlsx"
data.ls <- compileDatasets(data.dir, supp.f)

site.i <- read_csv(paste0(data.dir, "sitesDigitized.csv"),
                   col_select=1:3, show_col_types=F) %>%
  bind_rows(readxl::read_xlsx(supp.f, "siteLocations", skip=1) %>%
      select(Location, lat, lon) %>% rename(location=Location)) %>%
  group_by(lat, lon) %>% summarise(location=first(location)) %>% ungroup


lmType <- c("lm", "brms")[1]
PAR_datasource <- c("MODIS", "POWER")[1]
gridRes <- 0.25
```


# Covariates

```{r covariates}
covars.ls <- loadCovariates(gis.dir, UK_bbox, loadFile="data\\covar_ls.rds")
data.ls <- extractCovarsToDatasets(data.ls, covars.ls, PAR_datasource)
site.sf <- extractCovarsToPts(site.i, covars.ls, PAR_datasource)
grid.domain <- st_read(paste0("data\\grid_", gridRes, ".gpkg"))
```


# Regressions

```{r load_regressions}
lm.fit <- readRDS(paste0("data\\", lmType, "_fits.rds"))
```

```{r load_surv_fecund}
surv.df <- data.ls$stageFrom_stageTo %>% 
  filter(stageTo=="dead") %>%
  mutate(survRate=1-rate,
         exposure=as.numeric(factor(exposure, levels=c("low", "medium", "high"))))
fecund.df <- data.ls$stageFrom_stageTo %>% 
  filter(stageFrom=="canopy" & stageTo=="recruits") %>%
  mutate(exposure=as.numeric(factor(exposure, levels=c("low", "medium", "high"))))
```



# Parameter list

```{r set_parameters}
params <- list(tmax=50,
               depth=2,
               prFullHarvest=0, 
               freqHarvest=300, 
               harvestTarget="stipe"
               )

sites_pool <- site.sf %>% filter(!is.na(KD_mn)) %>% st_drop_geometry() %>%
  mutate(id=row_number())
grid.i <- sites_pool
grid.i <- grid.domain %>% st_drop_geometry()
```


# Run simulation

```{r run_simulations}
library(doParallel)
library(tictoc)
cl <- makePSOCKcluster(12)
registerDoParallel(cl)
tic()
out.ls <- foreach(i=1:nrow(grid.i), 
                  .packages=c("tidyverse", "brms", "lubridate")) %dopar% {
  par_i <- setParameters(
                tmax=params$tmax, 
                prFullHarvest=params$prFullHarvest, 
                freqHarvest=params$freqHarvest, 
                harvestTarget=params$harvestTarget,
                survRate=filter(surv.df, exposure==grid.i$fetchCat[i])$survRate^(1/2),
                settlementRateBg=filter(fecund.df, exposure==grid.i$fetchCat[i])$rate,
                extraPars=list(
                  depth=params$depth,
                  env=grid.i[i,],
                  lenSt_to_wtSt=lm.fit$lenSt_to_wtSt.lm,
                  lenSt_to_wtFr=lm.fit$lenSt_to_wtFr.lm,
                  lenSt_to_wtTot=lm.fit$lenSt_to_wtTot.lm,
                  wtFr_to_arFr=lm.fit$wtFr_to_arFr.lm,
                  arFr_to_wtFr=lm.fit$arFr_to_wtFr.lm,
                  N_canopy=lm.fit$N_canopy.lm,
                  FAI=lm.fit$FAI.lm,
                  canopyHeight=lm.fit$canopyHeight.lm)
                )
  out <- map(1:2, ~simulatePopulation(par_i, lmType=lmType, ndraws=20))
  list(out=imap_dfr(out, 
                    ~tibble(sim=.y, 
                            year=rep(1:par_i$tmax, 3),
                            month=rep(c(1,6,7), each=par_i$tmax),
                            date=ymd(paste0(year, "-", month, "-01")),
                            PAR_depth=.x$PAR,
                            FAI=c(.x$FAI[3,,]),
                            N.recruits=c(.x$N[1,,]),
                            N.subcanopy=c(.x$N[2,,]),
                            N.canopy=c(.x$N[3,,]),
                            K_N=.x$K_N,
                            K_FAI=.x$K_FAI) %>%
                      pivot_longer(contains("N."), names_to="stage", values_to="N") %>%
                      mutate(stage=factor(str_sub(stage, 3, -1), 
                                          levels=c("canopy", "subcanopy", "recruits")))) %>%
         add_column(par_i$env) %>%
         mutate(depth=par_i$depth),
       harvest=imap_dfr(out,
                        ~tibble(sim=.y,
                                year=1:par_i$tmax,
                                date=ymd(paste0(2000+year, "-06-01")),
                                PAR_depth=.x$PAR,
                                FAI.June=c(.x$FAI[3,,2]),
                                N.recruits.June=c(.x$N[1,,2]),
                                N.subcanopy.June=c(.x$N[2,,2]),
                                N.canopy.June=c(.x$N[3,,2]),
                                K_FAI=.x$K_FAI,
                                K_N=.x$K_N,
                                harvest=.x$harvest/1e3) %>%
                          mutate(cumulHarvest=cumsum(harvest))) %>%
         add_column(par_i$env) %>%
         mutate(depth=par_i$depth),
       biomass=imap_dfr(out,
                        ~tibble(sim=.y,
                                year=rep(1:par_i$tmax, 3),
                            month=rep(c(1,6,7), each=par_i$tmax),
                            date=ymd(paste0(year, "-", month, "-01")),
                            PAR_depth=.x$PAR,
                            biomass=c(.x$biomass),
                            FAI=c(.x$FAI[3,,]),
                            N.canopy=c(.x$N[3,,]))) %>%
         add_column(par_i$env) %>%
         mutate(depth=par_i$depth))
}
toc()
stopCluster(cl)
```


# Summarize

```{r summarise_output}
out.df <- do.call(rbind, map(out.ls, ~.x$out))
out.sum <- out.df %>% group_by(id, year, month, date, stage) %>%
  select(!c(sim)) %>%
  summarise(#N_q10=quantile(N, 0.1),
            # N_q25=quantile(N, 0.25),
            # N_q75=quantile(N, 0.75),
            # N_q90=quantile(N, 0.9),
            # FAI_q10=quantile(FAI, 0.1),
            # FAI_q25=quantile(FAI, 0.25),
            # FAI_q75=quantile(FAI, 0.75),
            # FAI_q90=quantile(FAI, 0.9),
            # K_FAI_q10=quantile(K_FAI, 0.1),
            # K_FAI_q90=quantile(K_FAI, 0.9),
            across(everything(), mean)) %>%
  ungroup
out.sum.sf <- full_join(grid.domain %>% select(id), out.sum, by="id")

harvest.df <- do.call(rbind, map(out.ls, ~.x$harvest))
harvest.sum <- harvest.df %>% group_by(id, year, date) %>%
  select(!c(sim)) %>%
  summarise(#harvest_q10=quantile(harvest, 0.1),
            # harvest_q25=quantile(harvest, 0.25),
            # harvest_q75=quantile(harvest, 0.75),
            # harvest_q90=quantile(harvest, 0.9),
            # cumulHarvest_q10=quantile(cumulHarvest, 0.1),
            # cumulHarvest_q25=quantile(cumulHarvest, 0.25),
            # cumulHarvest_q75=quantile(cumulHarvest, 0.75),
            # cumulHarvest_q90=quantile(cumulHarvest, 0.9),
            # K_FAI_q10=quantile(K_FAI, 0.1),
            # K_FAI_q90=quantile(K_FAI, 0.9),
            across(everything(), mean)) %>%
  ungroup
harvest.sum.sf <- full_join(grid.domain %>% select(id), harvest.sum, by="id")

mass.df <- do.call(rbind, map(out.ls, ~.x$biomass))
mass.sum <- mass.df %>% group_by(id, year, month, date) %>%
  select(!c(sim)) %>%
  summarise(#stipe_q10=quantile(stipeMass, 0.1),
            # stipe_q25=quantile(stipeMass, 0.25),
            # stipe_q75=quantile(stipeMass, 0.75),
            # stipe_q90=quantile(stipeMass, 0.9),
            # frond_q10=quantile(frondMass, 0.1),
            # frond_q25=quantile(frondMass, 0.25),
            # frond_q75=quantile(frondMass, 0.75),
            # frond_q90=quantile(frondMass, 0.9),
            # FAI_q10=quantile(FAI, 0.1),
            # FAI_q25=quantile(FAI, 0.25),
            # FAI_q75=quantile(FAI, 0.75),
            # FAI_q90=quantile(FAI, 0.9),
            # N.canopy_q10=quantile(N.canopy, 0.1),
            # N.canopy_q25=quantile(N.canopy, 0.25),
            # N.canopy_q75=quantile(N.canopy, 0.75),
            # N.canopy_q90=quantile(N.canopy, 0.9),
            across(everything(), mean)) %>%
  ungroup
mass.sum.sf <- full_join(grid.domain %>% select(id), mass.sum, by="id")
```


# Plots

```{r plot_output}
sample_pops <- sample(1:nrow(grid.i), 10)
out.sum %>% filter(month==6 & stage=="canopy") %>%
  filter(id %in% sample_pops) %>% #filter(year > 5) %>%
  mutate(fetchCat=paste("Exposure level:", fetchCat)) %>%
  ggplot(aes(year, FAI, group=id,# ymin=FAI_q10, ymax=FAI_q90, 
             colour=PAR_depth, fill=PAR_depth)) +
  # geom_ribbon(alpha=0.25, colour=NA) +
  # geom_ribbon(aes(ymin=FAI_q25, ymax=FAI_q75), 
  #             alpha=0.5, colour=NA) +
  geom_line(size=1) + 
  # geom_hline(aes(yintercept=K_FAI, colour=PAR_depth)) +
  scale_colour_viridis_c() + scale_fill_viridis_c() +
  ylim(0, NA) + facet_wrap(~fetchCat) +
  ggtitle(paste0("FAI dynamics (", params$depth, "m)"))
out.sum %>% filter(month==6 & stage=="canopy") %>%
  filter(id %in% sample_pops) %>%
  mutate(fetchCat=paste("Exposure level:", fetchCat)) %>%
  ggplot(aes(year, FAI/K_FAI, group=id,# ymin=FAI_q10/K_FAI, ymax=FAI_q90/K_FAI,
             colour=PAR_depth, fill=PAR_depth)) +
  # geom_ribbon(alpha=0.25, colour=NA) +
  # geom_ribbon(aes(ymin=FAI_q25/K_FAI, ymax=FAI_q75/K_FAI), 
  #             alpha=0.5, colour=NA) +
  geom_line(size=1) + 
  scale_colour_viridis_c() + scale_fill_viridis_c() +
  ylim(0, NA) + facet_wrap(~fetchCat) +
  ggtitle(paste0("kappa_FAI dynamics (", params$depth, "m)"))

out.sum %>% filter(month==6) %>% #filter(year > 5) %>%
  filter(id %in% sample_pops) %>%
  mutate(fetchCat=paste("Exposure level:", fetchCat)) %>%
  ggplot(aes(year, N, group=id,# ymin=N_q10, ymax=N_q90,
             colour=PAR_depth, fill=PAR_depth)) +
  # geom_ribbon(alpha=0.25, colour=NA) +
  geom_line(size=1) + 
  # geom_hline(aes(yintercept=K_N, colour=PAR_depth)) +
  scale_colour_viridis_c() + scale_fill_viridis_c() +
  ylim(0, NA) + facet_grid(stage~fetchCat, scales="free_y") +
  ggtitle(paste0("Abundance dynamics (", params$depth, "m)"))

out.sum %>% filter(month==1 & stage=="canopy") %>%
  filter(id %in% sample_pops) %>%
  mutate(fetchCat=paste("Exposure level:", fetchCat)) %>%
  ggplot(aes(date, FAI/N, group=id,
             colour=PAR_depth, fill=PAR_depth)) +
  geom_line(size=1) + 
  geom_hline(aes(yintercept=K_FAI/K_N, colour=PAR_depth)) +
  scale_colour_viridis_c() + scale_fill_viridis_c() +
  ylim(0, NA) + facet_wrap(~fetchCat) +
  ggtitle(paste0("FAI/indiv dynamics (", params$depth, "m)"))

mass.sum %>% filter(month==6) %>%
  filter(id %in% sample_pops) %>%
  mutate(fetchCat=paste("Exposure level:", fetchCat)) %>%
  ggplot(aes(year, biomass, group=id,# ymin=stipe_q10, ymax=stipe_q90,
             colour=PAR_depth, fill=PAR_depth)) +
  # geom_ribbon(alpha=0.25, colour=NA) +
  # geom_ribbon(aes(ymin=stipe_q25, ymax=stipe_q75), 
  #             alpha=0.5, colour=NA) +
  geom_line(size=1) + 
  scale_colour_viridis_c() + scale_fill_viridis_c() +
  ylim(0, NA) + facet_wrap(~fetchCat) +
  ggtitle(paste0("Biomass dynamics (", params$depth, "m)"))

mass.sum %>% 
  mutate(fetchCat=paste("Exposure level:", fetchCat)) %>%
  ggplot(aes(biomass, FAI, colour=PAR_depth)) + geom_point(shape=1) +
  scale_colour_viridis_c() + facet_grid(month~fetchCat)

harvest.sum %>% 
  ggplot(aes(year, cumulHarvest, ymin=cumulHarvest_q10, ymax=cumulHarvest_q90, group=id,
             colour=PAR_depth, fill=PAR_depth)) +
  geom_ribbon(alpha=0.25, colour=NA) +
  geom_ribbon(aes(ymin=cumulHarvest_q25, ymax=cumulHarvest_q75), 
              alpha=0.5, colour=NA) +
  geom_line(size=1) + 
  scale_colour_viridis_c() + scale_fill_viridis_c() +
  ylim(0, NA) + facet_wrap(~fetchCat)

harvest.sum %>% 
  filter(id %in% sample_pops) %>%
  ggplot(aes(year, cumulHarvest, ymin=cumulHarvest_q10, ymax=cumulHarvest_q90, group=id,
             colour=PAR_depth, fill=PAR_depth)) +
  geom_ribbon(alpha=0.25, colour=NA) +
  geom_ribbon(aes(ymin=cumulHarvest_q25, ymax=cumulHarvest_q75), 
              alpha=0.5, colour=NA) +
  geom_line(size=1) + 
  scale_colour_viridis_c() + scale_fill_viridis_c() +
  ylim(0, NA) + facet_wrap(~fetchCat)


harvest.sum.sf %>%
  filter(year==max(year)) %>%
  ggplot(aes(fill=cumulHarvest)) + 
  geom_sf() + scale_fill_viridis_c(paste(params$harvestTarget, "(kg)")) +
  ggtitle(paste0("Total harvest (", params$tmax, " yrs, ", params$depth, "m)"))
harvest.sum.sf %>%
  filter(date==max(date)) %>%
  ggplot(aes(fill=(cumulHarvest_q90-cumulHarvest_q10)/cumulHarvest)) + 
  geom_sf() + scale_fill_viridis_c(paste(params$harvestTarget, "(kg)")) +
  ggtitle(paste0("Total harvest CV (", params$tmax, " yrs, ", params$depth, "m)"))

out.sum.sf %>%
  filter(month==1 & stage=="canopy") %>%
  ggplot(aes(fill=FAI)) + 
  geom_sf(colour=NA) + scale_fill_viridis_c() +
  facet_wrap(~year, ncol=10) +
  ggtitle(paste0("January FAI (", params$depth, "m)"))
out.sum.sf %>%
  filter(month==1 & stage=="canopy") %>%
  ggplot(aes(fill=N)) + 
  geom_sf(colour=NA) + scale_fill_viridis_c() +
  facet_wrap(~year, ncol=10) +
  ggtitle(paste0("January canopy density (", params$depth, "m)"))
mass.sum.sf %>%
  filter(month==1) %>% filter(year > 4) %>%
  ggplot(aes(fill=biomass)) + 
  geom_sf(colour=NA) + scale_fill_viridis_c() +
  facet_wrap(~year, ncol=10) +
  ggtitle(paste0("January biomass (", params$depth, "m)"))


out.sum.sf %>%
  filter(month==6 & stage=="canopy") %>%
  ggplot(aes(fill=FAI)) + 
  geom_sf(colour=NA) + scale_fill_viridis_c() +
  facet_wrap(~year, ncol=10) +
  ggtitle(paste0("1 July FAI (", params$depth, "m)")) +
  theme(axis.text=element_blank(), axis.ticks=element_blank())
out.sum.sf %>%
  filter(month==6 & stage=="canopy") %>%
  ggplot(aes(fill=N)) + 
  geom_sf(colour=NA) + scale_fill_viridis_c() +
  facet_wrap(~year, ncol=10) +
  ggtitle(paste0("1 July canopy density (", params$depth, "m)"))
mass.sum.sf %>%
  filter(month==6) %>% filter(year > 4) %>%
  ggplot(aes(fill=stipeMass)) + 
  geom_sf(colour=NA) + scale_fill_viridis_c() +
  facet_wrap(~year, ncol=10) +
  ggtitle(paste0("1 July stipe mass (", params$depth, "m)"))
mass.sum.sf %>%
  filter(month==6) %>% filter(year > 4) %>%
  ggplot(aes(fill=(stipeMass+frondMass)/1e3)) + 
  geom_sf(colour=NA) + scale_fill_viridis_c("kg") +
  facet_wrap(~year, ncol=9) +
  ggtitle(paste0("1 July biomass (", params$depth, "m)")) + 
  theme(axis.text=element_blank(), axis.ticks=element_blank())
mass.sum.sf %>%
  filter(month==6) %>% filter(year > 4) %>%
  ggplot(aes(fill=stipe_q90-stipe_q10)) + 
  geom_sf(colour=NA) + scale_fill_viridis_c() +
  facet_wrap(~year, ncol=10) +
  ggtitle(paste0("1 July stipe mass CI width (", params$depth, "m)"))

out.sum.sf %>% 
  filter(month==6 & stage=="canopy") %>%
  group_by(id) %>%
  summarise(FAI=mean(FAI)) %>%
  ggplot(aes(fill=FAI)) + 
  geom_sf(colour=NA) + scale_fill_viridis_c() +
  ggtitle(paste0("Mean 1 July FAI (", params$depth, "m)")) +
  theme(axis.text=element_blank(), axis.ticks=element_blank(), legend.position="bottom")
out.sum.sf %>% 
  filter(month==6 & stage=="canopy") %>%
  group_by(id) %>%
  summarise(N=mean(N)) %>%
  ggplot(aes(fill=N)) + 
  geom_sf(colour=NA) + scale_fill_viridis_c() +
  ggtitle(paste0("Mean 1 July canopy density (", params$depth, "m)")) +
  theme(axis.text=element_blank(), axis.ticks=element_blank(), legend.position="bottom")
mass.sum.sf %>% 
  filter(month==6) %>%
  group_by(id) %>%
  summarise(stipeMass=mean(stipeMass)/1e3) %>%
  ggplot(aes(fill=stipeMass)) + 
  geom_sf(colour=NA) + scale_fill_viridis_c() +
  ggtitle(paste0("Mean 1 July stipe mass (", params$depth, "m)")) +
  theme(axis.text=element_blank(), axis.ticks=element_blank(), legend.position="bottom")
mass.sum.sf %>% 
  filter(month==6) %>%
  group_by(id) %>%
  summarise(frondMass=mean(frondMass)/1e3) %>%
  ggplot(aes(fill=frondMass)) + 
  geom_sf(colour=NA) + scale_fill_viridis_c() +
  ggtitle(paste0("Mean 1 July frond mass (", params$depth, "m)")) +
  theme(axis.text=element_blank(), axis.ticks=element_blank(), legend.position="bottom")
mass.sum.sf %>% 
  filter(month==6) %>%
  group_by(id) %>%
  summarise(biomass=mean(stipeMass + frondMass)/1e3) %>%
  ggplot(aes(fill=biomass)) + 
  geom_sf(colour=NA) + scale_fill_viridis_c("kg") +
  ggtitle(paste0("Mean 1 July biomass (", params$depth, "m)")) +
  theme(axis.text=element_blank(), axis.ticks=element_blank(), legend.position="bottom")
mass.sum.sf %>% 
  filter(month==6) %>%
  group_by(id) %>%
  summarise(FAI=mean(FAI)) %>%
  ggplot(aes(fill=log(FAI))) + 
  geom_sf(colour=NA) + scale_fill_viridis_c() +
  ggtitle(paste0("Mean 1 July log FAI (", params$depth, "m)")) +
  theme(axis.text=element_blank(), axis.ticks=element_blank(), legend.position="bottom")
harvest.sum.sf %>%
  filter(year==max(year)) %>%
  ggplot(aes(fill=cumulHarvest)) + 
  geom_sf(colour=NA) + scale_fill_viridis_c(paste(params$harvestTarget, "(kg)")) +
  ggtitle(paste0("Total harvest (", params$tmax, " yrs, ", params$depth, "m)")) +
  theme(axis.text=element_blank(), axis.ticks=element_blank(), legend.position="bottom")





out.df %>% filter(stage=="canopy" & month==6) %>% 
  ggplot(aes(date, FAI, colour=PAR_depth, group=paste(id, sim))) + 
  geom_line() + scale_colour_viridis_c(option="E")


out.df %>% filter(stage=="canopy" & month==6) %>%
  ggplot(aes(year, log(N), colour=PAR_depth)) + 
  geom_point() + geom_line(aes(group=paste(id, sim))) + 
  scale_colour_viridis_c()
out.df %>% filter(stage=="canopy" & month==6) %>%
  ggplot(aes(year, FAI, colour=PAR_depth)) + 
  geom_point() + geom_line(aes(group=paste(id, sim))) + 
  scale_colour_viridis_c()
harvest.df %>%
  ggplot(aes(year, harvest, colour=PAR_depth)) + 
  geom_point() + 
  scale_colour_viridis_c()
harvest.df %>%
  ggplot(aes(year, cumulHarvest, colour=PAR_depth)) + 
  geom_line(aes(group=paste(id, sim))) + 
  scale_colour_viridis_c()
harvest.df %>%
  ggplot(aes(year, cumulHarvest, colour=PAR_depth)) + 
  geom_line(aes(group=paste(id, sim))) + 
  scale_colour_viridis_c() + facet_grid(.~fetchCat)


library(gganimate)
anim <- out.sum.sf %>% filter(stage=="canopy") %>%
  ggplot() + geom_sf(aes(fill=N)) + transition_states(date) +
  scale_fill_viridis_c() 
anim_save("canopy_N.gif", anim, nframes=90)

anim <- out.sum.sf %>% filter(stage=="canopy") %>%
  ggplot() + geom_sf(aes(fill=FAI)) + transition_states(date) +
  scale_fill_viridis_c() 
anim_save("canopy_FAI.gif", anim, nframes=90)

anim <- mass.sum.sf %>% 
  ggplot() + geom_sf(aes(fill=stipeMass)) + transition_states(date) +
  scale_fill_viridis_c() 
anim_save("biomass_stipe.gif", anim, nframes=90)

anim <- mass.sum.sf %>% 
  ggplot() + geom_sf(aes(fill=(stipeMass+frondMass)/1e3)) + 
  transition_states(date) +
  scale_fill_viridis_c("Biomass (kg)") 
anim_save("biomass_all.gif", anim, nframes=90)

anim <- harvest.sum.sf %>% 
  ggplot() + geom_sf(aes(fill=harvest)) + transition_states(date) +
  scale_fill_viridis_c() 
anim_save("harvest.gif", anim, nframes=90)
```



```{r}
out.sum %>% filter(year==50 & month==6 & stage=="canopy") %>%
  mutate(PAR_atDepth=PAR_surface*exp(-KD_mn*2), 
         fetch_ecdf=ecdf(fetch)(fetch), 
         sst_ecdf=ecdf(sstDay_mn)(sstDay_mn),
         KD_ecdf=ecdf(KD_mn)(KD_mn),
         PAR_ecdf=ecdf(PAR_surface)(PAR_surface)) %>% 
  mutate(PARdepth_ecdf=ecdf(PAR_atDepth)(PAR_atDepth)) %>% 
  filter(id %in% bigN$id) %>% 
  select(id, contains("_ecdf")) %>% 
  ggplot(aes(PAR_ecdf, sst_ecdf, colour=fetch_ecdf)) + 
  geom_point() + xlim(0,1) + ylim(0,1) + scale_colour_viridis_c(limits=c(0,1))
```

